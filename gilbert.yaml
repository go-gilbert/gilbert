version: 1.0
vars:
  buildDir: './build'
  version: '0.4.1'
  commit: '{% git log --format=%H -n 1 %}'

mixins:
  async-test:
    - plugin: shell
      async: true
      params:
        command: 'foo'
  platform-build:
    - plugin: build
      description: 'build for {{os}} {{arch}}'
      vars:
        ext: ''
      params:
        outputPath: '{{buildDir}}/gilbert_{{os}}-{{arch}}{{ext}}'
        target:
          os: '{{os}}'
          arch: '{{arch}}'
        variables:
          'main.version': '{{ version }}'
          'main.commit': '{{ commit }}'

tasks:
  test-deadline-async:
    - plugin: shell
      deadline: 2000
      async: true
      params:
        command: 'sleep 4'
    - plugin: shell
      params:
        command: 'ping -c 5 localhost'
  test-async:
    - mixin: async-test
    - plugin: shell
      params:
        command: 'uname -a'
    - plugin: shell
      async: true
      params:
        command: 'ping -c 5 localhost'
  install:
  - plugin: build
    params:
      outputPath: '{{GOPATH}}/bin/gilbert'
      variables:
        'main.version': '{{ version }}'
        'main.commit': '{{ commit }}'

  lint:
    - plugin: shell
      params:
        command: 'gometalinter ./...'
  pre-install:
  - plugin: go-get
    params:
      packages:
        - github.com/stretchr/testify
  build:
  - plugin: build
    params:
      variables:
        'main.version': '{{ version }}'
        'main.commit': '{{ commit }}'
  - if: 'uname -a'
    description: "show a message only if job runs on UNIX"
    plugin: shell
    params:
      command: 'echo This is UNIX machine'

  release:
  - mixin: platform-build
    vars:
      os: windows
      arch: '386'
      ext: '.exe'
  - mixin: platform-build
    vars:
      os: windows
      arch: 'amd64'
      ext: .exe
  - mixin: platform-build
    if: '[ $(uname -s) == "Darwin" ]'
    vars:
      os: darwin
      arch: 'amd64'
  - mixin: platform-build
    vars:
      os: linux
      arch: 'amd64'
  - mixin: platform-build
    vars:
      os: linux
      arch: '386'
  - mixin: platform-build
    vars:
      os: freebsd
      arch: '386'
  - mixin: platform-build
    vars:
      os: freebsd
      arch: 'amd64'